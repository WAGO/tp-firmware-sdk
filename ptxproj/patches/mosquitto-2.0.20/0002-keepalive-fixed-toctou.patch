From: "daniel.martens" <daniel.martens@wago.com>
Date: Tue, 8 Jul 2025 11:32:02 +0200
Subject: [PATCH] keepalive: fixed toctou

---
 lib/thread_mosq.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/lib/thread_mosq.c b/lib/thread_mosq.c
index a792bc12b035..64a0f70ded41 100644
--- a/lib/thread_mosq.c
+++ b/lib/thread_mosq.c
@@ -122,12 +122,13 @@ void *mosquitto__thread_main(void *obj)
 		}
 	}while(1);
 
-	if(!mosq->keepalive){
+	uint16_t keepalive = mosq->keepalive;
+	if(!keepalive){
 		/* Sleep for a day if keepalive disabled. */
 		mosquitto_loop_forever(mosq, 1000*86400, 1);
 	}else{
 		/* Sleep for our keepalive value. publish() etc. will wake us up. */
-		mosquitto_loop_forever(mosq, mosq->keepalive*1000, 1);
+		mosquitto_loop_forever(mosq, keepalive*1000, 1);
 	}
 	if(mosq->threaded == mosq_ts_self){
 		mosq->threaded = mosq_ts_none;
